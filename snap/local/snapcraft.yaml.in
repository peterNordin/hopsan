name: hopsan
version: 'HOPSAN_FULL_RELEASE_VERSION'
summary: A modelling and simulation tool for fluid power and mechatronic systems.
description: |
  Hopsan is a modelling and simulation environment for fluid and mechatronic systems. It was originally developed for simulation of fluid power systems, but has also been extended with support for other domains such as electric power, mechanics, flight and vehicle dynamics.
  Hopsan uses bi-directional delay lines, (or transmission line elements TLM) to connect physical component models, but also supports signal flow modelling with common mathematical operators and functions.
icon: HopsanGUI/graphics/uiicons/hopsan.png
license: (Apache-2.0 AND GPL-3.0)

grade: HOPSAN_SNAP_GRADE
confinement: strict

base: core22

compression: lzo

layout:
  /usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/libmvec_nonshared.a:
    bind-file: $SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/libmvec_nonshared.a
  /usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/libc_nonshared.a:
    bind-file: $SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/libc_nonshared.a
  /usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/libpthread_nonshared.a:
    bind-file: $SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/libpthread_nonshared.a

apps:
  cli:
    command: usr/local/hopsan/bin/hopsancli
    plugs: [home]
    environment:
      CPATH: $SNAP/usr/include:$SNAP/usr/include/${SNAPCRAFT_ARCH_TRIPLET}
      CPLUS_INCLUDE_PATH: $SNAP/usr/include/c++/11:$SNAP/usr/include

  gui:
    command: usr/local/hopsan/bin/hopsangui
    common-id: com.github.hopsan.hopsangui
    extensions: [kde-neon]
    plugs: [home, unity7, network]
    desktop: usr/share/applications/HopsanGUI.desktop
    environment:
#      LIBGL_DRIVERS_PATH: $SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/dri
      CPATH: $SNAP/usr/include:$SNAP/usr/include/${SNAPCRAFT_ARCH_TRIPLET}
      CPLUS_INCLUDE_PATH: $SNAP/usr/include/c++/11:$SNAP/usr/include

  addresserver:
    command: usr/local/hopsan/bin/hopsanaddresserver
    plugs: [home, network, network-bind]

  server:
    command: usr/local/hopsan/bin/hopsanserver
    plugs: [home, network, network-bind]
    environment:
      CPATH: $SNAP/usr/include:$SNAP/usr/include/${SNAPCRAFT_ARCH_TRIPLET}
      CPLUS_INCLUDE_PATH: $SNAP/usr/include/c++/11:$SNAP/usr/include

  serverworker:
    command: usr/local/hopsan/bin/hopsanserverworker
    plugs: [home, network, network-bind]
    environment:
      CPATH: $SNAP/usr/include:$SNAP/usr/include/${SNAPCRAFT_ARCH_TRIPLET}
      CPLUS_INCLUDE_PATH: $SNAP/usr/include/c++/11:$SNAP/usr/include

  remoteclient:
    command: usr/local/hopsan/bin/hopsanremoteclient
    plugs: [home, network]

  servermonitor:
    command: usr/local/hopsan/bin/hopsanservermonitor
    plugs: [home, network]

# slots:
#   session-dbus-interface:
#     interface: dbus
#     name: com.github.hopsan.hopsangui
#     bus: session

parts:
  hopsan:
    source: .
    plugin: cmake
    cmake-generator: Ninja
    cmake-parameters:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_USER_DOCUMENTATION=ON
      - -DBUILD_DEVELOPER_DOCUMENTATION=OFF
      - -DCMAKE_INSTALL_PREFIX=/usr/local/hopsan
    build-packages:
      - cmake
      - doxygen
      - dvipng
      - graphviz
      - inkscape
      - libgl-dev
      - libhdf5-dev
      - libmarkdown2-dev
      - libmsgpack-dev
      - libtool-bin
      - libzmq3-dev
      - ninja-build
      - patchelf
      - pkg-config
      - python3
      - texlive
      - texlive-font-utils
      - texlive-latex-extra
      - unzip
    build-snaps:
      - kf5-5-108-qt-5-15-10-core22-sdk
      - kf5-5-108-qt-5-15-10-core22
    stage-packages:
      - g++
      - libhdf5-103
      - libhdf5-cpp-103
      - libmarkdown2
      - libzmq5
      - make
      - zip
    override-build: |
      mkdir -p /root/dependencies-cache
      cd ../src
      git reset --hard
      git clean -ffdx
      ./packaging/prepareSourceCode.sh $(pwd) $(pwd) HOPSAN_BASE_VERSION HOPSAN_RELEASE_REVISION HOPSAN_FULL_RELEASE_VERSION HOPSAN_DEVELOPMENT_RELEASE false
      cd dependencies
      ./download-dependencies.py --cache /root/dependencies-cache fmi4c fmilibrary katex tclap qwt
      ./setupFmi4c.sh
      ./setupFMILibrary.sh
      ./setupKatex.sh
      ./setupTclap.sh
      ./setupQwt.sh
      cd ..
      snapcraftctl build

      install -Dm644 -t $SNAPCRAFT_PART_INSTALL/usr/share/icons/hicolor/128x128/apps HopsanGUI/graphics/uiicons/hopsan128x128.png
      install -Dm644 -t $SNAPCRAFT_PART_INSTALL/usr/share/applications HopsanGUI/HopsanGUI.desktop
      sed -i 's|Icon=.*|Icon=${SNAP}/usr/share/icons/hicolor/128x128/apps/hopsan128x128.png|g' $SNAPCRAFT_PART_INSTALL/usr/share/applications/HopsanGUI.desktop
      sed -i 's|Exec=.*|Exec=hopsan.gui|g' $SNAPCRAFT_PART_INSTALL/usr/share/applications/HopsanGUI.desktop
      sed -i 's|Path=.*|Path=${SNAP}/usr/local/hopsan/bin|g' $SNAPCRAFT_PART_INSTALL/usr/share/applications/HopsanGUI.desktop
    build-environment:
      - HOPSAN_BUILD_QT_QMAKE: /snap/kf5-5-108-qt-5-15-10-core22-sdk/current/usr/lib/x86_64-linux-gnu/qt5/bin/qmake
